<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zane.org - Posts</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, limit, orderBy }
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBrJIVH_Hh7V_VdzwEiiY0nkdozqSh8zl0",
            authDomain: "zane-3342f.firebaseapp.com",
            projectId: "zane-3342f",
            storageBucket: "zane-3342f.firebasestorage.app",
            messagingSenderId: "430530723375",
            appId: "1:430530723375:web:3c31fbf6836988856050da"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let postsArray = []; // Store posts to shuffle them
        let postIndex = 0;
        const chunkSize = 5; // Load posts in chunks of 5

        // Handle user login state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById("post-section").style.display = "block";
                document.getElementById("logout-button").style.display = "block";
                document.getElementById("login-button").style.display = "none";
            } else {
                document.getElementById("post-section").style.display = "none";
                document.getElementById("logout-button").style.display = "none";
                document.getElementById("login-button").style.display = "block";
            }
        });

        // Fetch posts randomly in chunks
        async function loadPosts() {
            if (postsArray.length === 0) {
                const querySnapshot = await getDocs(query(collection(db, "posts"), orderBy("timestamp", "desc")));
                postsArray = querySnapshot.docs.map(doc => doc.data());

                // Shuffle posts randomly
                for (let i = postsArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [postsArray[i], postsArray[j]] = [postsArray[j], postsArray[i]];
                }
            }

            const postList = document.getElementById("post-list");

            // Load next chunk of posts
            for (let i = 0; i < chunkSize && postIndex < postsArray.length; i++, postIndex++) {
                const post = postsArray[postIndex];
                const postElement = document.createElement("div");
                postElement.classList.add("post");
                postElement.innerHTML = `<strong>${sanitizeHTML(post.username)}</strong>: ${sanitizeHTML(post.content)}`;
                postList.appendChild(postElement);
            }
        }

        // Prevent XSS attacks by escaping HTML
        function sanitizeHTML(str) {
            return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        // Load more posts when scrolling
        window.onscroll = () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                loadPosts();
            }
        };

        window.logout = () => {
            signOut(auth).then(() => window.location.reload());
        };

        window.onload = loadPosts;
    </script>
</head>
<body>
    <div class="container">
        <!-- Login button at the top -->
        <button id="login-button" onclick="window.location.href='login.html'">Login</button>
        <button id="logout-button" onclick="logout()" style="display: none;">Logout</button>

        <h1>Zane.org - Posts</h1>

        <!-- Post creation section (Hidden for guests) -->
        <div id="post-section" style="display: none;">
            <textarea id="content" rows="3" placeholder="Write your post..."></textarea>
            <button onclick="createPost()">Post</button>
        </div>

        <h2>Recent Posts:</h2>
        <div id="post-list"></div>
    </div>
</body>
</html>
