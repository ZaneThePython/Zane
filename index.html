<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zane.org - Posts</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module">
        fetch('/firebase-config')
            .then(response => response.json())
            .then(config => {
                import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js').then(({ initializeApp }) => {
                    import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js').then(({ getAuth, onAuthStateChanged, signOut }) => {
                        import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js').then(({ getFirestore, collection, addDoc, getDocs, serverTimestamp, doc, getDoc, updateDoc, increment }) => {
                            
                            const app = initializeApp(config);
                            const auth = getAuth(app);
                            const db = getFirestore(app);
                            window.firebaseAuth = auth;
                            window.firebaseDb = db;

                            let userLoggedIn = false;

                            onAuthStateChanged(auth, (user) => {
                                userLoggedIn = !!user;
                                document.getElementById("post-section").style.display = user ? "block" : "none";
                                document.getElementById("logout-button").style.display = user ? "block" : "none";
                                document.getElementById("login-button").style.display = user ? "none" : "block";
                            });

                            window.createPost = async function () {
                                const user = auth.currentUser;
                                if (!user) return;

                                const content = document.getElementById("content").innerText.trim();
                                if (content === "") return;

                                const userDoc = await getDoc(doc(db, "users", user.uid));
                                const username = userDoc.exists() ? userDoc.data().username : "Unknown";

                                await addDoc(collection(db, "posts"), {
                                    username: username,
                                    content: content,
                                    timestamp: serverTimestamp(),
                                    likes: 0
                                });

                                document.getElementById("content").innerText = "";
                                loadPosts();
                            };

                            window.likePost = async function (postId) {
                                if (!userLoggedIn) {
                                    alert("You must be logged in to like posts!");
                                    return;
                                }
                                const postRef = doc(db, "posts", postId);
                                await updateDoc(postRef, { likes: increment(1) });
                                loadPosts();
                            };

                            function sanitizeHTML(str) {
                                return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                            }

                            window.logout = () => signOut(auth);
                            window.onload = loadPosts;
                        });
                    });
                });
            })
            .catch(error => console.error("Failed to load Firebase config:", error));
    </script>
</head>
<body>
    <button id="login-button" onclick="window.location.href='login.html'">Login</button>
    <button id="logout-button" onclick="logout()" style="display: none;">Logout</button>
    <div id="post-section">
        <div contenteditable="true" id="content" class="custom-textbox"></div>
        <button onclick="createPost()">Post</button>
    </div>
    <div id="post-list"></div>
</body>
</html>
