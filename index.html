<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, doc, getDoc, updateDoc, arrayUnion, query, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ✅ Firebase Config (Directly Included)
    const firebaseConfig = {
        apiKey: "AIzaSyBrJIVH_Hh7V_VdzwEiiY0nkdozqSh8zl0",
        authDomain: "zane-3342f.firebaseapp.com",
        projectId: "zane-3342f",
        storageBucket: "zane-3342f.firebasestorage.app",
        messagingSenderId: "430530723375",
        appId: "1:430530723375:web:3c31fbf6836988856050da"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userLoggedIn = false;

    onAuthStateChanged(auth, (user) => {
        userLoggedIn = !!user;
        document.getElementById("post-section").style.display = user ? "block" : "none";
        document.getElementById("logout-button").style.display = user ? "block" : "none";
        document.getElementById("login-button").style.display = user ? "none" : "block";
    });

    window.createPost = async function () {
        const user = auth.currentUser;
        if (!user) return;

        const content = document.getElementById("content").value.trim();
        if (content === "") return;

        const userDoc = await getDoc(doc(db, "users", user.uid));
        const username = userDoc.exists() ? userDoc.data().username : "Unknown";

        await addDoc(collection(db, "posts"), {
            username: username,
            content: content,
            timestamp: serverTimestamp(),
            likes: 0,
            likedBy: [],
            replies: [] // Stores replies as an array
        });

        document.getElementById("content").value = "";
        loadPosts();
    };

    window.likePost = async function (postId, buttonElement) {
        const user = auth.currentUser;
        if (!user) {
            alert("You must be logged in to like posts!");
            return;
        }

        const postRef = doc(db, "posts", postId);
        const postSnap = await getDoc(postRef);

        if (postSnap.exists()) {
            const postData = postSnap.data();
            if (postData.likedBy && postData.likedBy.includes(user.uid)) {
                alert("You have already liked this post!");
                return;
            }

            await updateDoc(postRef, {
                likes: postData.likes + 1,
                likedBy: arrayUnion(user.uid)
            });

            buttonElement.innerHTML = `❤️ ${postData.likes + 1}`;
        }
    };

    window.replyToPost = async function (postId) {
        const user = auth.currentUser;
        if (!user) {
            alert("You must be logged in to reply!");
            return;
        }

        const replyInput = document.getElementById(`reply-input-${postId}`);
        const replyContent = replyInput.value.trim();
        if (replyContent === "") return;

        const userDoc = await getDoc(doc(db, "users", user.uid));
        const username = userDoc.exists() ? userDoc.data().username : "Unknown";

        const postRef = doc(db, "posts", postId);
        await updateDoc(postRef, {
            replies: arrayUnion({ username: username, content: replyContent, timestamp: Date.now() })
        });

        replyInput.value = "";
        loadPosts(); // Reload posts to show replies
    };

    async function loadPosts() {
        const postList = document.getElementById("post-list");
        postList.innerHTML = "";

        try {
            const postsQuery = query(collection(db, "posts"), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(postsQuery);

            if (querySnapshot.empty) {
                console.warn("No posts found.");
                postList.innerHTML = "<p>No posts available.</p>";
                return;
            }

            let postsArray = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            postsArray.forEach((post) => {
                const postElement = document.createElement("div");
                postElement.classList.add("post");
                postElement.innerHTML = `
                    <div class="post-header">
                        <strong>${sanitizeHTML(post.username)}</strong>
                    </div>
                    <p>${sanitizeHTML(post.content)}</p>
                    <button class="like-button" onclick="likePost('${post.id}', this)">❤️ ${post.likes || 0}</button>
                    <div class="replies">
                        <input type="text" id="reply-input-${post.id}" placeholder="Write a reply..." class="reply-input">
                        <button class="reply-button" onclick="replyToPost('${post.id}')">Reply</button>
                        ${post.replies && post.replies.length > 0 ? post.replies.map(reply => `
                            <div class="reply">
                                <strong>${sanitizeHTML(reply.username)}</strong>: ${sanitizeHTML(reply.content)}
                            </div>
                        `).join("") : ""}
                    </div>
                `;
                postList.appendChild(postElement);
            });

        } catch (error) {
            console.error("Error loading posts:", error);
            postList.innerHTML = `<p>Error loading posts. Check console for details.</p>`;
        }
    }

    function sanitizeHTML(str) {
        return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    window.logout = () => signOut(auth);
    window.onload = () => loadPosts();
</script>
