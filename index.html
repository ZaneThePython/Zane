<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, doc, getDoc, updateDoc, arrayUnion, query, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ‚úÖ Firebase Config (Directly Included)
    const firebaseConfig = {
        apiKey: "AIzaSyBrJIVH_Hh7V_VdzwEiiY0nkdozqSh8zl0",
        authDomain: "zane-3342f.firebaseapp.com",
        projectId: "zane-3342f",
        storageBucket: "zane-3342f.firebasestorage.app",
        messagingSenderId: "430530723375",
        appId: "1:430530723375:web:3c31fbf6836988856050da"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userLoggedIn = false;

    window.onload = () => {
        console.log("DOM fully loaded. Running script...");
        loadPosts();
    };

    onAuthStateChanged(auth, (user) => {
        userLoggedIn = !!user;
        const postSection = document.getElementById("post-section");
        const loginButton = document.getElementById("login-button");
        const logoutButton = document.getElementById("logout-button");

        if (postSection) postSection.style.display = user ? "block" : "none";
        if (loginButton) loginButton.style.display = user ? "none" : "block";
        if (logoutButton) logoutButton.style.display = user ? "block" : "none";
    });

    window.createPost = async function () {
        const user = auth.currentUser;
        if (!user) return;

        const content = document.getElementById("content").value.trim();
        if (content === "") {
            alert("Post cannot be empty.");
            return;
        }

        const userDoc = await getDoc(doc(db, "users", user.uid));
        const username = userDoc.exists() ? userDoc.data().username : "Unknown";

        await addDoc(collection(db, "posts"), {
            username: username,
            content: content,
            timestamp: serverTimestamp(),
            likes: 0,
            dislikes: 0,
            likedBy: [],
            dislikedBy: []
        });

        document.getElementById("content").value = "";
        loadPosts();
    };

    async function loadPosts() {
        const postList = document.getElementById("post-list");
        if (!postList) return console.error("Error: #post-list element not found.");

        postList.innerHTML = "";

        try {
            const postsQuery = query(collection(db, "posts"), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(postsQuery);

            if (querySnapshot.empty) {
                console.warn("No posts found.");
                postList.innerHTML = "<p>No posts available.</p>";
                return;
            }

            let postsArray = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            postsArray.forEach((post) => {
                const postElement = document.createElement("div");
                postElement.classList.add("post");
                postElement.innerHTML = `
                    <div class="post-header">
                        <strong>${sanitizeHTML(post.username)}</strong>
                    </div>
                    <p>${sanitizeHTML(post.content)}</p>
                    <button class="like-button" onclick="likePost('${post.id}', this)">‚ù§Ô∏è ${post.likes || 0}</button>
                    <button class="dislike-button" onclick="dislikePost('${post.id}', this)">üëé ${post.dislikes || 0}</button>
                `;
                postList.appendChild(postElement);
            });

        } catch (error) {
            console.error("Error loading posts:", error);
            postList.innerHTML = `<p>Error loading posts. Check console for details.</p>`;
        }
    }

    window.likePost = async function (postId, buttonElement) {
        const user = auth.currentUser;
        if (!user) {
            alert("You must be logged in to like posts!");
            return;
        }

        const postRef = doc(db, "posts", postId);
        const postSnap = await getDoc(postRef);

        if (postSnap.exists()) {
            const postData = postSnap.data();
            if (postData.likedBy.includes(user.uid)) {
                alert("You have already liked this post!");
                return;
            }

            await updateDoc(postRef, {
                likes: postData.likes + 1,
                likedBy: arrayUnion(user.uid)
            });

            buttonElement.innerHTML = `‚ù§Ô∏è ${postData.likes + 1}`;
        }
    };

    window.dislikePost = async function (postId, buttonElement) {
        const user = auth.currentUser;
        if (!user) {
            alert("You must be logged in to dislike posts!");
            return;
        }

        const postRef = doc(db, "posts", postId);
        const postSnap = await getDoc(postRef);

        if (postSnap.exists()) {
            const postData = postSnap.data();
            if (postData.dislikedBy.includes(user.uid)) {
                alert("You have already disliked this post!");
                return;
            }

            await updateDoc(postRef, {
                dislikes: postData.dislikes + 1,
                dislikedBy: arrayUnion(user.uid)
            });

            buttonElement.innerHTML = `üëé ${postData.dislikes + 1}`;
        }
    };

    function sanitizeHTML(str) {
        return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    window.logout = () => signOut(auth);
</script>
