<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Zane.org</title>
    <link rel="stylesheet" href="auth-styles.css">
    <script type="module">
        fetch('/firebase-config')
            .then(response => response.json())
            .then(config => {
                import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js').then(({ initializeApp }) => {
                    import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js').then(({ getAuth, createUserWithEmailAndPassword, updateProfile }) => {
                        import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js').then(({ getFirestore, doc, setDoc, getDocs, collection, query, where }) => {
                            
                            const app = initializeApp(config);
                            const auth = getAuth(app);
                            const db = getFirestore(app);

                            window.signUp = async function () {
                                const username = document.getElementById("username").value.trim();
                                const email = document.getElementById("email").value.trim();
                                const password = document.getElementById("password").value;

                                if (username === "" || email === "" || password === "") {
                                    alert("All fields are required!");
                                    return;
                                }

                                // Check if username is taken
                                const usernameQuery = query(collection(db, "users"), where("username", "==", username));
                                getDocs(usernameQuery).then(usernameSnapshot => {
                                    if (!usernameSnapshot.empty) {
                                        alert("Username is already taken!");
                                        return;
                                    }

                                    // Create user
                                    createUserWithEmailAndPassword(auth, email, password)
                                        .then(userCredential => {
                                            const user = userCredential.user;
                                            updateProfile(user, { displayName: username });

                                            // Store user info in Firestore
                                            return setDoc(doc(db, "users", user.uid), { username: username, email: email });
                                        })
                                        .then(() => {
                                            alert("Account created! Redirecting to login...");
                                            window.location.href = "login.html";
                                        })
                                        .catch(error => alert("Error: " + error.message));
                                });
                            };
                        });
                    });
                });
            })
            .catch(error => console.error("Failed to load Firebase config:", error));
    </script>
</head>
<body>
    <div class="auth-container">
        <h2>Sign Up</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="signUp()">Sign Up</button>
        <p>Already have an account? <a href="login.html">Login here</a></p>
    </div>
</body>
</html>
